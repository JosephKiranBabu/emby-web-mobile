define(["browser","datetime","libraryBrowser","listView","userdataButtons","imageLoader","playbackManager","nowPlayingHelper","events","connectionManager","apphost","cardStyle"],function(browser,datetime,libraryBrowser,listView,userdataButtons,imageLoader,playbackManager,nowPlayingHelper,events,connectionManager,appHost){"use strict";function showAudioMenu(context,player,button,item,currentIndex){var streams=(item.MediaStreams||[]).filter(function(i){return"Audio"==i.Type}),menuItems=streams.map(function(s){var menuItem={name:s.DisplayTitle,id:s.Index};return s.Index==currentIndex&&(menuItem.selected=!0),menuItem});require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:button,callback:function(id){player.setAudioStreamIndex(parseInt(id))}})})}function showSubtitleMenu(context,player,button,item,currentIndex){var streams=(item.MediaStreams||[]).filter(function(i){return"Subtitle"==i.Type}),menuItems=streams.map(function(s){var menuItem={name:s.DisplayTitle,id:s.Index};return s.Index==currentIndex&&(menuItem.selected=!0),menuItem});menuItems.unshift({id:-1,name:Globalize.translate("ButtonOff"),selected:null==currentIndex}),require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:button,callback:function(id){player.setSubtitleStreamIndex(parseInt(id))}})})}function showButton(button){button.classList.remove("hide")}function hideButton(button){button.classList.add("hide")}function hasStreams(item,type){return item&&item.MediaStreams&&item.MediaStreams.filter(function(i){return i.Type==type}).length>0}function getNowPlayingNameHtml(nowPlayingItem,includeNonNameInfo){var names=nowPlayingHelper.getNowPlayingNames(nowPlayingItem,includeNonNameInfo);return names.map(function(i){return i.text}).join("<br/>")}function seriesImageUrl(item,options){if("Episode"!==item.Type)return null;if(options=options||{},options.type=options.type||"Primary","Primary"===options.type&&item.SeriesPrimaryImageTag)return options.tag=item.SeriesPrimaryImageTag,connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.SeriesId,options);if("Thumb"===options.type){if(item.SeriesThumbImageTag)return options.tag=item.SeriesThumbImageTag,connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.SeriesId,options);if(item.ParentThumbImageTag)return options.tag=item.ParentThumbImageTag,connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.ParentThumbItemId,options)}return null}function imageUrl(item,options){return options=options||{},options.type=options.type||"Primary",item.ImageTags&&item.ImageTags[options.type]?(options.tag=item.ImageTags[options.type],connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.PrimaryImageItemId||item.Id,options)):item.AlbumId&&item.AlbumPrimaryImageTag?(options.tag=item.AlbumPrimaryImageTag,connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.AlbumId,options)):null}function updateNowPlayingInfo(context,state){var item=state.NowPlayingItem,displayName=item?getNowPlayingNameHtml(item).replace("<br/>"," - "):"";context.querySelector(".nowPlayingPageTitle").innerHTML=displayName,displayName.length>0?context.querySelector(".nowPlayingPageTitle").classList.remove("hide"):context.querySelector(".nowPlayingPageTitle").classList.add("hide");var url=item?seriesImageUrl(item,{maxHeight:300})||imageUrl(item,{maxHeight:300}):null,backdropUrl=null;url!==currentImgUrl&&(item&&item.BackdropImageTag&&(backdropUrl=ApiClient.getScaledImageUrl(item.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:item.BackdropImageTag,index:0})),setImageUrl(context,url),item?(browser.slow||require(["backdrop"],function(backdrop){backdrop.setBackdrop(backdropUrl)}),ApiClient.getItem(Dashboard.getCurrentUserId(),item.Id).then(function(fullItem){userdataButtons.fill({item:fullItem,includePlayed:!1,style:"fab-mini",element:context.querySelector(".nowPlayingPageUserDataButtons")})})):userdataButtons.destroy({element:context.querySelector(".nowPlayingPageUserDataButtons")}))}function setImageUrl(context,url){currentImgUrl=url,url?imageLoader.lazyImage(context.querySelector(".nowPlayingPageImage"),url):context.querySelector(".nowPlayingPageImage").style.backgroundImage=""}function buttonEnabled(btn,enabled){btn.disabled=!enabled}function updateSupportedCommands(context,commands){for(var all=context.querySelectorAll(".btnCommand"),i=0,length=all.length;i<length;i++)buttonEnabled(all[i],commands.indexOf(all[i].getAttribute("data-command"))!=-1)}function hideChapterMenu(page){}var currentImgUrl;return function(){function toggleRepeat(player){if(player&&lastPlayerState){var state=lastPlayerState;switch((state.PlayState||{}).RepeatMode){case"RepeatNone":playbackManager.setRepeatMode("RepeatAll",player);break;case"RepeatAll":playbackManager.setRepeatMode("RepeatOne",player);break;case"RepeatOne":playbackManager.setRepeatMode("RepeatNone",player)}}}function updatePlayerState(context,state){lastPlayerState=state;var item=state.NowPlayingItem,playerInfo=playbackManager.getPlayerInfo(),supportedCommands=playerInfo.supportedCommands,playState=state.PlayState||{};buttonEnabled(context.querySelector(".btnToggleFullscreen"),item&&"Video"==item.MediaType&&supportedCommands.indexOf("ToggleFullscreen")!=-1),buttonEnabled(context.querySelector(".btnAudioTracks"),hasStreams(item,"Audio")&&supportedCommands.indexOf("SetAudioStreamIndex")!=-1),buttonEnabled(context.querySelector(".btnSubtitles"),hasStreams(item,"Subtitle")&&supportedCommands.indexOf("SetSubtitleStreamIndex")!=-1),item&&item.Chapters&&item.Chapters.length&&playState.CanSeek?buttonEnabled(context.querySelector(".btnChapters"),!0):(buttonEnabled(context.querySelector(".btnChapters"),!1),hideChapterMenu(context)),supportedCommands.indexOf("DisplayMessage")!=-1?context.querySelector(".sendMessageSection").classList.remove("hide"):context.querySelector(".sendMessageSection").classList.add("hide"),supportedCommands.indexOf("SendString")!=-1?context.querySelector(".sendTextSection").classList.remove("hide"):context.querySelector(".sendTextSection").classList.add("hide"),buttonEnabled(context.querySelector(".btnStop"),null!=item),buttonEnabled(context.querySelector(".btnNextTrack"),null!=item),buttonEnabled(context.querySelector(".btnPreviousTrack"),null!=item);var positionSlider=context.querySelector(".nowPlayingPositionSlider");positionSlider&&!positionSlider.dragging&&(positionSlider.disabled=!playState.CanSeek),updatePlayPauseState(playState.IsPaused,null!=item);var runtimeTicks=item?item.RunTimeTicks:null;updateTimeDisplay(playState.PositionTicks,runtimeTicks),updatePlayerVolumeState(playState.IsMuted,playState.VolumeLevel),item&&"Video"==item.MediaType?context.classList.remove("hideVideoButtons"):context.classList.add("hideVideoButtons"),playerInfo.isLocalPlayer&&appHost.supports("physicalvolumecontrol")?context.classList.add("hideVolumeButtons"):context.classList.remove("hideVolumeButtons"),item&&"Audio"==item.MediaType?context.querySelector(".buttonsRow2").classList.add("hide"):context.querySelector(".buttonsRow2").classList.remove("hide");var toggleRepeatButton=context.querySelector(".repeatToggleButton");"RepeatAll"==playState.RepeatMode?(toggleRepeatButton.innerHTML="<i class='md-icon'>repeat</i>",toggleRepeatButton.classList.add("nowPlayingPageRepeatActive")):"RepeatOne"==playState.RepeatMode?(toggleRepeatButton.innerHTML="<i class='md-icon'>repeat_one</i>",toggleRepeatButton.classList.add("nowPlayingPageRepeatActive")):(toggleRepeatButton.innerHTML="<i class='md-icon'>repeat</i>",toggleRepeatButton.classList.remove("nowPlayingPageRepeatActive")),updateNowPlayingInfo(context,state)}function updatePlayerVolumeState(isMuted,volumeLevel){}function updatePlayPauseState(isPaused,isActive){var context=dlg,btnPause=context.querySelector(".btnPause"),btnPlay=context.querySelector(".btnPlay");buttonEnabled(btnPause,isActive),buttonEnabled(btnPlay,isActive),isPaused?(hideButton(btnPause),showButton(btnPlay)):(showButton(btnPause),hideButton(btnPlay))}function updateTimeDisplay(positionTicks,runtimeTicks){var context=dlg,positionSlider=context.querySelector(".nowPlayingPositionSlider");if(positionSlider&&!positionSlider.dragging)if(runtimeTicks){var pct=positionTicks/runtimeTicks;pct*=100,positionSlider.value=pct}else positionSlider.value=0;null==positionTicks?context.querySelector(".positionTime").innerHTML="--:--":context.querySelector(".positionTime").innerHTML=datetime.getDisplayRunningTime(positionTicks),null!=runtimeTicks?context.querySelector(".runtime").innerHTML=datetime.getDisplayRunningTime(runtimeTicks):context.querySelector(".runtime").innerHTML="--:--"}function loadPlaylist(context){var html="";html+=listView.getListViewHtml({items:playbackManager.playlist(),smallIcon:!0,action:"setplaylistindex"}),playlistNeedsRefresh=!1;var deps=[];require(deps,function(){var itemsContainer=context.querySelector(".playlist");itemsContainer.innerHTML=html;var index=playbackManager.currentPlaylistIndex();if(index!=-1){var item=itemsContainer.querySelectorAll(".listItem")[index];if(item){var img=item.querySelector(".listItemImage");img.classList.remove("lazy"),img.classList.add("playlistIndexIndicatorImage")}}imageLoader.lazyChildren(itemsContainer)})}function onPlaybackStart(e,state){console.log("remotecontrol event: "+e.type);var player=this;onStateChanged.call(player,e,state),loadPlaylist(dlg)}function onPlaybackStopped(e,state){console.log("remotecontrol event: "+e.type),updatePlayerState(dlg,{}),loadPlaylist(dlg)}function onPlayPauseStateChanged(e){var player=this;updatePlayPauseState(player.paused(),!0)}function onStateChanged(event,state){updatePlayerState(dlg,state)}function onTimeUpdate(e){var now=(new Date).getTime();if(!(now-lastUpdateTime<700)){lastUpdateTime=now;var player=this;currentRuntimeTicks=playbackManager.duration(player),updateTimeDisplay(playbackManager.currentTime(player),currentRuntimeTicks)}}function onVolumeChanged(e){var player=this;updatePlayerVolumeState(player.isMuted(),player.getVolume())}function releaseCurrentPlayer(){var player=currentPlayer;player&&(events.off(player,"playbackstart",onPlaybackStart),events.off(player,"statechange",onPlaybackStart),events.off(player,"repeatmodechange",onPlaybackStart),events.off(player,"playbackstop",onPlaybackStopped),events.off(player,"volumechange",onVolumeChanged),events.off(player,"pause",onPlayPauseStateChanged),events.off(player,"playing",onPlayPauseStateChanged),events.off(player,"timeupdate",onTimeUpdate),currentPlayer=null)}function bindToPlayer(context,player){if(releaseCurrentPlayer(),currentPlayer=player,player){playbackManager.getPlayerState(player).then(function(state){onStateChanged.call(player,{type:"init"},state)}),events.on(player,"playbackstart",onPlaybackStart),events.on(player,"statechange",onPlaybackStart),events.on(player,"repeatmodechange",onPlaybackStart),events.on(player,"playbackstop",onPlaybackStopped),events.on(player,"volumechange",onVolumeChanged),events.on(player,"pause",onPlayPauseStateChanged),events.on(player,"playing",onPlayPauseStateChanged),events.on(player,"timeupdate",onTimeUpdate);var playerInfo=playbackManager.getPlayerInfo(),supportedCommands=playerInfo.supportedCommands;currentPlayerSupportedCommands=supportedCommands,updateSupportedCommands(context,supportedCommands)}}function updateCastIcon(context){var info=playbackManager.getPlayerInfo(),btnCast=context.querySelector(".nowPlayingCastIcon");info&&!info.isLocalPlayer?(btnCast.querySelector("i").innerHTML="cast_connected",btnCast.classList.add("btnActiveCast"),context.querySelector(".nowPlayingSelectedPlayer").innerHTML=info.deviceName||info.name):(btnCast.querySelector("i").innerHTML="cast",btnCast.classList.remove("btnActiveCast"),context.querySelector(".nowPlayingSelectedPlayer").innerHTML="")}function onBtnCommandClick(){currentPlayer&&(this.classList.contains("repeatToggleButton")?toggleRepeat(currentPlayer):playbackManager.sendCommand({Name:this.getAttribute("data-command")},currentPlayer))}function bindEvents(context){for(var btnCommand=context.querySelectorAll(".btnCommand"),i=0,length=btnCommand.length;i<length;i++)btnCommand[i].addEventListener("click",onBtnCommandClick);context.querySelector(".btnToggleFullscreen").addEventListener("click",function(e){currentPlayer&&playbackManager.sendCommand({Name:e.target.getAttribute("data-command")},currentPlayer)}),context.querySelector(".btnAudioTracks").addEventListener("click",function(e){if(currentPlayer&&lastPlayerState&&lastPlayerState.PlayState){var currentIndex=lastPlayerState.PlayState.AudioStreamIndex;showAudioMenu(context,currentPlayer,e.target,lastPlayerState.NowPlayingItem,currentIndex)}}),context.querySelector(".btnSubtitles").addEventListener("click",function(e){if(currentPlayer&&lastPlayerState&&lastPlayerState.PlayState){var currentIndex=lastPlayerState.PlayState.SubtitleStreamIndex;showSubtitleMenu(context,currentPlayer,e.target,lastPlayerState.NowPlayingItem,currentIndex)}}),context.querySelector(".btnChapters").addEventListener("click",function(){}),context.querySelector(".btnStop").addEventListener("click",function(){currentPlayer&&playbackManager.stop(currentPlayer)}),context.querySelector(".btnPlay").addEventListener("click",function(){currentPlayer&&currentPlayer.unpause()}),context.querySelector(".btnPause").addEventListener("click",function(){currentPlayer&&currentPlayer.pause()}),context.querySelector(".btnNextTrack").addEventListener("click",function(){currentPlayer&&playbackManager.nextTrack(currentPlayer)}),context.querySelector(".btnPreviousTrack").addEventListener("click",function(){currentPlayer&&playbackManager.previousTrack(currentPlayer)}),context.querySelector(".nowPlayingPositionSlider").addEventListener("change",function(){var value=this.value;if(currentPlayer){var newPercent=parseFloat(value);playbackManager.seekPercent(newPercent,currentPlayer)}}),context.querySelector(".nowPlayingPositionSlider",context).getBubbleText=function(value){var state=lastPlayerState;if(!state||!state.NowPlayingItem||!currentRuntimeTicks)return"--:--";var ticks=currentRuntimeTicks;return ticks/=100,ticks*=value,datetime.getDisplayRunningTime(ticks)}}function onPlayerChange(){var context=dlg;updateCastIcon(context),bindToPlayer(context,playbackManager.getCurrentPlayer())}function onMessageSubmit(e){var form=e.target;return playbackManager.sendCommand({Name:"DisplayMessage",Arguments:{Header:form.querySelector("#txtMessageTitle").value,Text:form.querySelector("#txtMessageText",form).value}},currentPlayer),form.querySelector("input").value="",require(["toast"],function(toast){toast("Message sent.")}),e.preventDefault(),e.stopPropagation(),!1}function onSendStringSubmit(e){var form=e.target;return playbackManager.sendCommand({Name:"SendString",Arguments:{String:form.querySelector("#txtTypeText",form).value}},currentPlayer),form.querySelector("input").value="",require(["toast"],function(toast){toast("Text sent.")}),e.preventDefault(),e.stopPropagation(),!1}function init(ownerView,context){require(["css!css/nowplaying.css"]),bindEvents(context),context.querySelector(".sendMessageForm").addEventListener("submit",onMessageSubmit),context.querySelector(".typeTextForm").addEventListener("submit",onSendStringSubmit),context.querySelector(".nowPlayingCastIcon").addEventListener("click",function(){var btn=this;require(["playerSelectionMenu"],function(playerSelectionMenu){playerSelectionMenu.show(btn)})}),context.querySelector(".btnExitRemoteControl").addEventListener("click",function(){history.back()});var mdlTabs=context.querySelector(".libraryViewNav");context.querySelector(".libraryViewNav").classList.add("bottom"),libraryBrowser.configurePaperLibraryTabs(ownerView,mdlTabs,ownerView.querySelectorAll(".pageTabContent")),mdlTabs.addEventListener("tabchange",function(e){2==e.detail.selectedTabIndex&&playlistNeedsRefresh&&loadPlaylist(context)}),events.on(playbackManager,"playerchange",onPlayerChange)}function onDialogClosed(e){releaseCurrentPlayer(),events.off(playbackManager,"playerchange",onPlayerChange),lastPlayerState=null}function onShow(context,tab){currentImgUrl=null,bindToPlayer(context,playbackManager.getCurrentPlayer()),updateCastIcon(context)}var dlg,currentPlayer,lastPlayerState,currentPlayerSupportedCommands=[],lastUpdateTime=0,currentRuntimeTicks=0,self=this,playlistNeedsRefresh=!0;self.init=function(ownerView,context){dlg=context,init(ownerView,dlg)},self.onShow=function(){onShow(dlg,window.location.hash)},self.destroy=function(){onDialogClosed()}}});
define(["browser","datetime","libraryBrowser","listView","userdataButtons","cardStyle"],function(browser,datetime,libraryBrowser,listView,userdataButtons){"use strict";function showAudioMenu(context,player,button,item,currentIndex){var streams=(item.MediaStreams||[]).filter(function(i){return"Audio"==i.Type}),menuItems=streams.map(function(s){var name=(s.Codec||"").toUpperCase();s.Profile&&(name+=" "+s.Profile),s.Language&&(name+=" · "+s.Language),s.Layout?name+=" · "+s.Layout:s.Channels&&(name+=" · "+s.Channels+" ch");var menuItem={name:s.DisplayTitle||name,id:s.Index};return s.Index==currentIndex&&(menuItem.selected=!0),menuItem});require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:button,callback:function(id){player.setAudioStreamIndex(parseInt(id))}})})}function showSubtitleMenu(context,player,button,item,currentIndex){var streams=(item.MediaStreams||[]).filter(function(i){return"Subtitle"==i.Type}),menuItems=streams.map(function(s){var name=s.Language||Globalize.translate("LabelUnknownLanguage");s.IsDefault&&s.IsForced?name+=" · "+Globalize.translate("LabelDefaultForcedStream"):s.IsDefault?name+=" · "+Globalize.translate("LabelDefaultStream"):s.IsForced&&(name+=" · "+Globalize.translate("LabelForcedStream")),s.Codec&&(name+=" · "+s.Codec.toUpperCase());var menuItem={name:s.DisplayTitle||name,id:s.Index};return s.Index==currentIndex&&(menuItem.selected=!0),menuItem});menuItems.unshift({id:-1,name:Globalize.translate("ButtonOff"),selected:null==currentIndex}),require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:button,callback:function(id){player.setSubtitleStreamIndex(parseInt(id))}})})}function showButton(button){button.classList.remove("hide")}function hideButton(button){button.classList.add("hide")}function hasStreams(item,type){return item&&item.MediaStreams&&item.MediaStreams.filter(function(i){return i.Type==type}).length>0}function updateNowPlayingInfo(context,state){var item=state.NowPlayingItem,displayName=item?MediaController.getNowPlayingNameHtml(item).replace("<br/>"," - "):"";context.querySelector(".nowPlayingPageTitle").innerHTML=displayName,displayName.length>0?context.querySelector(".nowPlayingPageTitle").classList.remove("hide"):context.querySelector(".nowPlayingPageTitle").classList.add("hide");var url,backdropUrl=null;item&&(item.PrimaryImageTag?url=ApiClient.getScaledImageUrl(item.PrimaryImageItemId,{type:"Primary",maxHeight:300,tag:item.PrimaryImageTag}):item.BackdropImageTag?url=ApiClient.getScaledImageUrl(item.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:item.BackdropImageTag,index:0}):item.ThumbImageTag&&(url=ApiClient.getScaledImageUrl(item.ThumbImageItemId,{type:"Thumb",maxHeight:300,tag:item.ThumbImageTag}))),url!=currentImgUrl&&(item&&item.BackdropImageTag&&(backdropUrl=ApiClient.getScaledImageUrl(item.BackdropItemId,{type:"Backdrop",maxHeight:300,tag:item.BackdropImageTag,index:0})),setImageUrl(context,url),item?(browser.slow||require(["backdrop"],function(backdrop){backdrop.setBackdrop(backdropUrl)}),ApiClient.getItem(Dashboard.getCurrentUserId(),item.Id).then(function(fullItem){userdataButtons.fill({item:fullItem,includePlayed:!1,style:"fab-mini",element:context.querySelector(".nowPlayingPageUserDataButtons")})})):userdataButtons.destroy({element:context.querySelector(".nowPlayingPageUserDataButtons")}))}function setImageUrl(context,url){currentImgUrl=url,url?ImageLoader.lazyImage(context.querySelector(".nowPlayingPageImage"),url):context.querySelector(".nowPlayingPageImage").style.backgroundImage=""}function buttonEnabled(btn,enabled){btn.disabled=!enabled}function updateSupportedCommands(context,commands){for(var all=context.querySelectorAll(".btnCommand"),i=0,length=all.length;i<length;i++)buttonEnabled(all[i],commands.indexOf(all[i].getAttribute("data-command"))!=-1)}function hideChapterMenu(page){}var currentImgUrl;return function(){function toggleRepeat(player){if(player&&lastPlayerState){var state=lastPlayerState;switch((state.PlayState||{}).RepeatMode){case"RepeatNone":player.setRepeatMode("RepeatAll");break;case"RepeatAll":player.setRepeatMode("RepeatOne");break;case"RepeatOne":player.setRepeatMode("RepeatNone")}}}function updatePlayerState(context,state){lastPlayerState=state;var item=state.NowPlayingItem,playerInfo=MediaController.getPlayerInfo(),supportedCommands=playerInfo.supportedCommands,playState=state.PlayState||{};buttonEnabled(context.querySelector(".btnToggleFullscreen"),item&&"Video"==item.MediaType&&supportedCommands.indexOf("ToggleFullscreen")!=-1),buttonEnabled(context.querySelector(".btnAudioTracks"),hasStreams(item,"Audio")&&supportedCommands.indexOf("SetAudioStreamIndex")!=-1),buttonEnabled(context.querySelector(".btnSubtitles"),hasStreams(item,"Subtitle")&&supportedCommands.indexOf("SetSubtitleStreamIndex")!=-1),item&&item.Chapters&&item.Chapters.length&&playState.CanSeek?buttonEnabled(context.querySelector(".btnChapters"),!0):(buttonEnabled(context.querySelector(".btnChapters"),!1),hideChapterMenu(context)),supportedCommands.indexOf("DisplayMessage")!=-1?context.querySelector(".sendMessageSection").classList.remove("hide"):context.querySelector(".sendMessageSection").classList.add("hide"),supportedCommands.indexOf("SendString")!=-1?context.querySelector(".sendTextSection").classList.remove("hide"):context.querySelector(".sendTextSection").classList.add("hide"),buttonEnabled(context.querySelector(".btnStop"),null!=item),buttonEnabled(context.querySelector(".btnNextTrack"),null!=item),buttonEnabled(context.querySelector(".btnPreviousTrack"),null!=item);var btnPause=context.querySelector(".btnPause"),btnPlay=context.querySelector(".btnPlay");buttonEnabled(btnPause,null!=item),buttonEnabled(btnPlay,null!=item),playState.IsPaused?(hideButton(btnPause),showButton(btnPlay)):(showButton(btnPause),hideButton(btnPlay));var positionSlider=context.querySelector(".nowPlayingPositionSlider");if(!positionSlider.dragging){if(item&&item.RunTimeTicks){var pct=playState.PositionTicks/item.RunTimeTicks;pct*=100,positionSlider.value=pct}else positionSlider.value=0;positionSlider.disabled=!playState.CanSeek}null==playState.PositionTicks?context.querySelector(".positionTime").innerHTML="--:--":context.querySelector(".positionTime").innerHTML=datetime.getDisplayRunningTime(playState.PositionTicks),item&&null!=item.RunTimeTicks?context.querySelector(".runtime").innerHTML=datetime.getDisplayRunningTime(item.RunTimeTicks):context.querySelector(".runtime").innerHTML="--:--",item&&"Video"==item.MediaType?context.classList.remove("hideVideoButtons"):context.classList.add("hideVideoButtons"),playerInfo.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons?context.classList.add("hideVolumeButtons"):context.classList.remove("hideVolumeButtons"),item&&"Audio"==item.MediaType?context.querySelector(".buttonsRow2").classList.add("hide"):context.querySelector(".buttonsRow2").classList.remove("hide");var toggleRepeatButton=context.querySelector(".repeatToggleButton");"RepeatAll"==playState.RepeatMode?(toggleRepeatButton.innerHTML="<i class='md-icon'>repeat</i>",toggleRepeatButton.classList.add("nowPlayingPageRepeatActive")):"RepeatOne"==playState.RepeatMode?(toggleRepeatButton.innerHTML="<i class='md-icon'>repeat_one</i>",toggleRepeatButton.classList.add("nowPlayingPageRepeatActive")):(toggleRepeatButton.innerHTML="<i class='md-icon'>repeat</i>",toggleRepeatButton.classList.remove("nowPlayingPageRepeatActive")),updateNowPlayingInfo(context,state)}function loadPlaylist(context){var html="";html+=listView.getListViewHtml({items:MediaController.playlist(),smallIcon:!0,action:"setplaylistindex"}),playlistNeedsRefresh=!1;var deps=[];require(deps,function(){var itemsContainer=context.querySelector(".playlist");itemsContainer.innerHTML=html;var index=MediaController.currentPlaylistIndex();if(index!=-1){var item=itemsContainer.querySelectorAll(".listItem")[index];if(item){var img=item.querySelector(".listItemImage");img.classList.remove("lazy"),img.classList.add("playlistIndexIndicatorImage")}}ImageLoader.lazyChildren(itemsContainer)})}function onStateChanged(e,state){if("positionchange"==e.type){var now=(new Date).getTime();if(now-lastUpdateTime<700)return;lastUpdateTime=now}updatePlayerState(dlg,state)}function onPlaybackStart(e,state){var player=this;player.beginPlayerUpdates(),onStateChanged.call(player,e,state),loadPlaylist(dlg)}function onPlaybackStopped(e,state){var player=this;player.endPlayerUpdates(),onStateChanged.call(player,e,{}),loadPlaylist(dlg)}function releaseCurrentPlayer(){currentPlayer&&(Events.off(currentPlayer,"playbackstart",onPlaybackStart),Events.off(currentPlayer,"playbackstop",onPlaybackStopped),Events.off(currentPlayer,"volumechange",onStateChanged),Events.off(currentPlayer,"playstatechange",onStateChanged),Events.off(currentPlayer,"positionchange",onStateChanged),currentPlayer.endPlayerUpdates(),currentPlayer=null)}function bindToPlayer(context,player){releaseCurrentPlayer(),currentPlayer=player,player.getPlayerState().then(function(state){state.NowPlayingItem&&player.beginPlayerUpdates(),onStateChanged.call(player,{type:"init"},state)}),Events.on(player,"playbackstart",onPlaybackStart),Events.on(player,"playbackstop",onPlaybackStopped),Events.on(player,"volumechange",onStateChanged),Events.on(player,"playstatechange",onStateChanged),Events.on(player,"positionchange",onStateChanged);var playerInfo=MediaController.getPlayerInfo(),supportedCommands=playerInfo.supportedCommands;updateSupportedCommands(context,supportedCommands)}function updateCastIcon(context){var info=MediaController.getPlayerInfo(),btnCast=context.querySelector(".nowPlayingCastIcon");info.isLocalPlayer?(btnCast.querySelector("i").innerHTML="cast",btnCast.classList.remove("btnActiveCast"),context.querySelector(".nowPlayingSelectedPlayer").innerHTML=""):(btnCast.querySelector("i").innerHTML="cast_connected",btnCast.classList.add("btnActiveCast"),context.querySelector(".nowPlayingSelectedPlayer").innerHTML=info.deviceName||info.name)}function onBtnCommandClick(){currentPlayer&&(this.classList.contains("repeatToggleButton")?toggleRepeat(currentPlayer):MediaController.sendCommand({Name:this.getAttribute("data-command")},currentPlayer))}function bindEvents(context){for(var btnCommand=context.querySelectorAll(".btnCommand"),i=0,length=btnCommand.length;i<length;i++)btnCommand[i].addEventListener("click",onBtnCommandClick);context.querySelector(".btnToggleFullscreen").addEventListener("click",function(e){currentPlayer&&MediaController.sendCommand({Name:e.target.getAttribute("data-command")},currentPlayer)}),context.querySelector(".btnAudioTracks").addEventListener("click",function(e){if(currentPlayer&&lastPlayerState&&lastPlayerState.PlayState){var currentIndex=lastPlayerState.PlayState.AudioStreamIndex;showAudioMenu(context,currentPlayer,e.target,lastPlayerState.NowPlayingItem,currentIndex)}}),context.querySelector(".btnSubtitles").addEventListener("click",function(e){if(currentPlayer&&lastPlayerState&&lastPlayerState.PlayState){var currentIndex=lastPlayerState.PlayState.SubtitleStreamIndex;showSubtitleMenu(context,currentPlayer,e.target,lastPlayerState.NowPlayingItem,currentIndex)}}),context.querySelector(".btnChapters").addEventListener("click",function(){}),context.querySelector(".btnStop").addEventListener("click",function(){currentPlayer&&currentPlayer.stop()}),context.querySelector(".btnPlay").addEventListener("click",function(){currentPlayer&&currentPlayer.unpause()}),context.querySelector(".btnPause").addEventListener("click",function(){currentPlayer&&currentPlayer.pause()}),context.querySelector(".btnNextTrack").addEventListener("click",function(){currentPlayer&&currentPlayer.nextTrack()}),context.querySelector(".btnPreviousTrack").addEventListener("click",function(){currentPlayer&&currentPlayer.previousTrack()}),context.querySelector(".nowPlayingPositionSlider").addEventListener("change",function(){var value=this.value;if(currentPlayer&&lastPlayerState){var newPercent=parseFloat(value),newPositionTicks=newPercent/100*lastPlayerState.NowPlayingItem.RunTimeTicks;currentPlayer.seek(Math.floor(newPositionTicks))}}),context.querySelector(".nowPlayingPositionSlider",context).getBubbleText=function(value){var state=lastPlayerState;if(!state||!state.NowPlayingItem||!state.NowPlayingItem.RunTimeTicks)return"--:--";var ticks=state.NowPlayingItem.RunTimeTicks;return ticks/=100,ticks*=value,datetime.getDisplayRunningTime(ticks)}}function onPlayerChange(){var context=dlg;updateCastIcon(context),bindToPlayer(context,MediaController.getCurrentPlayer())}function onMessageSubmit(e){var form=e.target;return MediaController.sendCommand({Name:"DisplayMessage",Arguments:{Header:form.querySelector("#txtMessageTitle").value,Text:form.querySelector("#txtMessageText",form).value}},currentPlayer),form.querySelector("input").value="",require(["toast"],function(toast){toast("Message sent.")}),e.preventDefault(),e.stopPropagation(),!1}function onSendStringSubmit(e){var form=e.target;return MediaController.sendCommand({Name:"SendString",Arguments:{String:form.querySelector("#txtTypeText",form).value}},currentPlayer),form.querySelector("input").value="",require(["toast"],function(toast){toast("Text sent.")}),e.preventDefault(),e.stopPropagation(),!1}function init(ownerView,context){require(["css!css/nowplaying.css"]),bindEvents(context),context.querySelector(".sendMessageForm").addEventListener("submit",onMessageSubmit),context.querySelector(".typeTextForm").addEventListener("submit",onSendStringSubmit),context.querySelector(".nowPlayingCastIcon").addEventListener("click",function(){MediaController.showPlayerSelection()}),context.querySelector(".btnExitRemoteControl").addEventListener("click",function(){history.back()});var mdlTabs=context.querySelector(".libraryViewNav");context.querySelector(".libraryViewNav").classList.add("bottom"),libraryBrowser.configurePaperLibraryTabs(ownerView,mdlTabs,ownerView.querySelectorAll(".pageTabContent")),mdlTabs.addEventListener("tabchange",function(e){2==e.detail.selectedTabIndex&&playlistNeedsRefresh&&loadPlaylist(context)}),Events.on(MediaController,"playerchange",onPlayerChange)}function onDialogClosed(e){releaseCurrentPlayer(),Events.off(MediaController,"playerchange",onPlayerChange),lastPlayerState=null}function onShow(context,tab){currentImgUrl=null,bindToPlayer(context,MediaController.getCurrentPlayer()),updateCastIcon(context)}var dlg,currentPlayer,lastPlayerState,lastUpdateTime=0,self=this,playlistNeedsRefresh=!0;self.init=function(ownerView,context){dlg=context,init(ownerView,dlg)},self.onShow=function(){onShow(dlg,window.location.hash)},self.destroy=function(){onDialogClosed()}}});
define(["libraryBrowser","emby-tabs","emby-button"],function(libraryBrowser){function getDefaultSection(index){if(AppInfo.isNativeApp)switch(index){case 0:return defaultFirstSection;case 1:return"resume";case 2:return"nextup";case 3:return"latestmovies";case 4:return"latestepisodes";case 5:return"latesttvrecordings";default:return""}switch(index){case 0:return defaultFirstSection;case 1:return"resume";case 2:return"latestmedia";case 3:return"latesttvrecordings";default:return""}}function loadSection(page,user,displayPreferences,index){var userId=user.Id,section=displayPreferences.CustomPrefs["home"+index]||getDefaultSection(index);"folders"==section&&(section=defaultFirstSection);var showLibraryTileNames="0"!=displayPreferences.CustomPrefs.enableLibraryTileNames,elem=page.querySelector(".section"+index);return"latestmedia"==section?Sections.loadRecentlyAdded(elem,user):"latestmovies"==section?Sections.loadLatestMovies(elem,user):"latestepisodes"==section?Sections.loadLatestEpisodes(elem,user):"librarytiles"==section?Sections.loadLibraryTiles(elem,user,"backdrop",index,!1,showLibraryTileNames):"smalllibrarytiles"==section?Sections.loadLibraryTiles(elem,user,"smallBackdrop",index,!1,showLibraryTileNames):"smalllibrarytiles-automobile"==section?Sections.loadLibraryTiles(elem,user,"smallBackdrop",index,!0,showLibraryTileNames):"librarytiles-automobile"==section?Sections.loadLibraryTiles(elem,user,"backdrop",index,!0,showLibraryTileNames):"librarybuttons"==section?Sections.loadlibraryButtons(elem,userId,index):"resume"==section?Sections.loadResume(elem,userId):"nextup"==section?Sections.loadNextUp(elem,userId):"latesttvrecordings"==section?Sections.loadLatestLiveTvRecordings(elem,userId):"latestchannelmedia"==section?Sections.loadLatestChannelMedia(elem,userId):(elem.innerHTML="",new Promise(function(resolve,reject){resolve()}))}function loadSections(page,user,displayPreferences){var i,length,sectionCount=6,elem=page.querySelector(".sections");if(!elem.innerHTML.length){var html="";for(i=0,length=sectionCount;i<length;i++)html+='<div class="homePageSection section'+i+'"></div>';elem.innerHTML=html}var promises=[];for(i=0,length=sectionCount;i<length;i++)promises.push(loadSection(page,user,displayPreferences,i));return Promise.all(promises)}function displayPreferencesKey(){return AppInfo.isNativeApp?"Emby Mobile":"webclient"}function dismissWelcome(page,userId){getDisplayPreferences("home",userId).then(function(result){result.CustomPrefs[homePageTourKey]=homePageDismissValue,ApiClient.updateDisplayPreferences("home",result,userId,displayPreferencesKey())})}function showWelcomeIfNeeded(page,displayPreferences){if(displayPreferences.CustomPrefs[homePageTourKey]==homePageDismissValue)page.querySelector(".welcomeMessage").classList.add("hide");else{Dashboard.hideLoadingMsg();var elem=page.querySelector(".welcomeMessage");elem.classList.remove("hide"),displayPreferences.CustomPrefs[homePageTourKey]?(elem.querySelector(".tourHeader").innerHTML=Globalize.translate("HeaderWelcomeBack"),elem.querySelector(".tourButtonText").innerHTML=Globalize.translate("ButtonTakeTheTourToSeeWhatsNew")):(elem.querySelector(".tourHeader").innerHTML=Globalize.translate("HeaderWelcomeToProjectWebClient"),elem.querySelector(".tourButtonText").innerHTML=Globalize.translate("ButtonTakeTheTour"))}}function takeTour(page,userId){require(["slideshow"],function(){var slides=[{imageUrl:"css/images/tour/web/tourcontent.jpg",title:Globalize.translate("WebClientTourContent")},{imageUrl:"css/images/tour/web/tourmovies.jpg",title:Globalize.translate("WebClientTourMovies")},{imageUrl:"css/images/tour/web/tourmouseover.jpg",title:Globalize.translate("WebClientTourMouseOver")},{imageUrl:"css/images/tour/web/tourtaphold.jpg",title:Globalize.translate("WebClientTourTapHold")},{imageUrl:"css/images/tour/web/tourmysync.png",title:Globalize.translate("WebClientTourMySync")},{imageUrl:"css/images/tour/web/toureditor.png",title:Globalize.translate("WebClientTourMetadataManager")},{imageUrl:"css/images/tour/web/tourplaylist.png",title:Globalize.translate("WebClientTourPlaylists")},{imageUrl:"css/images/tour/web/tourcollections.jpg",title:Globalize.translate("WebClientTourCollections")},{imageUrl:"css/images/tour/web/tourusersettings1.png",title:Globalize.translate("WebClientTourUserPreferences1")},{imageUrl:"css/images/tour/web/tourusersettings2.png",title:Globalize.translate("WebClientTourUserPreferences2")},{imageUrl:"css/images/tour/web/tourusersettings3.png",title:Globalize.translate("WebClientTourUserPreferences3")},{imageUrl:"css/images/tour/web/tourusersettings4.png",title:Globalize.translate("WebClientTourUserPreferences4")},{imageUrl:"css/images/tour/web/tourmobile1.jpg",title:Globalize.translate("WebClientTourMobile1")},{imageUrl:"css/images/tour/web/tourmobile2.png",title:Globalize.translate("WebClientTourMobile2")},{imageUrl:"css/images/tour/enjoy.jpg",title:Globalize.translate("MessageEnjoyYourStay")}];require(["slideshow"],function(slideshow){var newSlideShow=new slideshow({slides:slides,interactive:!0,loop:!1});newSlideShow.show(),dismissWelcome(page,userId),page.querySelector(".welcomeMessage").classList.add("hide")})})}function loadHomeTab(page,tabContent){if(window.ApiClient){var userId=Dashboard.getCurrentUserId();Dashboard.showLoadingMsg(),getDisplayPreferences("home",userId).then(function(result){Dashboard.getCurrentUser().then(function(user){loadSections(tabContent,user,result).then(function(){AppInfo.isNativeApp||showWelcomeIfNeeded(page,result),Dashboard.hideLoadingMsg()})})})}}function getDisplayPreferences(key,userId){return ApiClient.getDisplayPreferences(key,userId,displayPreferencesKey())}var defaultFirstSection="smalllibrarytiles",homePageDismissValue="14",homePageTourKey="homePageTour";return function(view,params){function getTabController(page,index,callback){var depends=[];switch(index){case 0:depends.push("scripts/sections");break;case 1:depends.push("scripts/homenextup");break;case 2:depends.push("scripts/homefavorites");break;case 3:depends.push("scripts/homeupcoming");break;default:return}require(depends,function(controllerFactory){var tabContent;0==index&&(tabContent=view.querySelector(".pageTabContent[data-index='"+index+"']"),self.tabContent=tabContent);var controller=tabControllers[index];controller||(tabContent=view.querySelector(".pageTabContent[data-index='"+index+"']"),controller=index?new controllerFactory(view,params,tabContent):self,tabControllers[index]=controller,controller.initTab&&controller.initTab()),callback(controller)})}function preLoadTab(page,index){getTabController(page,index,function(controller){renderedTabs.indexOf(index)==-1&&controller.preRender&&controller.preRender()})}function loadTab(page,index){getTabController(page,index,function(controller){renderedTabs.indexOf(index)==-1&&(renderedTabs.push(index),controller.renderTab())})}function onPlaybackStop(e,state){state.NowPlayingItem&&"Video"==state.NowPlayingItem.MediaType&&viewTabs.triggerTabChange()}function onWebSocketMessage(e,data){var msg=data;"UserDataChanged"===msg.MessageType&&msg.Data.UserId==Dashboard.getCurrentUserId()&&(renderedTabs=[])}var self=this;self.renderTab=function(){var tabContent=view.querySelector(".pageTabContent[data-index='0']");loadHomeTab(view,tabContent)};var viewTabs=view.querySelector(".libraryViewNav");libraryBrowser.configurePaperLibraryTabs(view,viewTabs,view.querySelectorAll(".pageTabContent"),[0,1,2,3],AppInfo.enableHomeTabs);var tabControllers=[],renderedTabs=[];viewTabs.addEventListener("beforetabchange",function(e){preLoadTab(view,parseInt(e.detail.selectedTabIndex))}),viewTabs.addEventListener("tabchange",function(e){loadTab(view,parseInt(e.detail.selectedTabIndex))}),view.querySelector(".btnTakeTour").addEventListener("click",function(){takeTour(view,Dashboard.getCurrentUserId())}),AppInfo.enableHomeTabs?(view.classList.remove("noSecondaryNavPage"),view.querySelector(".libraryViewNav").classList.remove("hide")):(view.classList.add("noSecondaryNavPage"),view.querySelector(".libraryViewNav").classList.add("hide")),view.addEventListener("viewshow",function(e){Events.on(MediaController,"playbackstop",onPlaybackStop),Events.on(ApiClient,"websocketmessage",onWebSocketMessage)}),view.addEventListener("viewbeforehide",function(e){Events.off(MediaController,"playbackstop",onPlaybackStop),Events.off(ApiClient,"websocketmessage",onWebSocketMessage)}),require(["headroom-window"],function(headroom){headroom.add(viewTabs),self.headroom=headroom}),view.addEventListener("viewdestroy",function(e){self.headroom&&self.headroom.remove(viewTabs)})}});
define(["appSettings","events","browser"],function(appSettings,events,browser){"use strict";function mirrorItem(info){var item=info.item;MediaController.getCurrentPlayer().displayContent({ItemName:item.Name,ItemId:item.Id,ItemType:item.Type,Context:info.context})}function mirrorIfEnabled(info){if(info=info||currentDisplayInfo,info&&MediaController.enableDisplayMirroring()){var player=MediaController.getPlayerInfo();player.isLocalPlayer||player.supportedCommands.indexOf("DisplayContent")==-1||mirrorItem(info)}}function monitorPlayer(player){events.on(player,"playbackstart",function(e,state){var info={QueueableMediaTypes:state.NowPlayingItem.MediaType,ItemId:state.NowPlayingItem.Id,NowPlayingItem:state.NowPlayingItem};info=Object.assign(info,state.PlayState),ApiClient.reportPlaybackStart(info)}),events.on(player,"playbackstop",function(e,state){var stopInfo={itemId:state.NowPlayingItem.Id,mediaSourceId:state.PlayState.MediaSourceId,positionTicks:state.PlayState.PositionTicks};state.PlayState.LiveStreamId&&(stopInfo.LiveStreamId=state.PlayState.LiveStreamId),state.PlayState.PlaySessionId&&(stopInfo.PlaySessionId=state.PlayState.PlaySessionId),ApiClient.reportPlaybackStopped(stopInfo)})}function showPlayerSelection(button,enableHistory){var playerInfo=MediaController.getPlayerInfo();return playerInfo.isLocalPlayer?(Dashboard.showLoadingMsg(),void MediaController.getTargets().then(function(targets){var menuItems=targets.map(function(t){var name=t.name;return t.appName&&t.appName!=t.name&&(name+=" - "+t.appName),{name:name,id:t.id,selected:playerInfo.id==t.id}});require(["actionsheet"],function(actionsheet){Dashboard.hideLoadingMsg();var menuOptions={title:Globalize.translate("HeaderSelectPlayer"),items:menuItems,positionTo:button,resolveOnClick:!0};enableHistory!==!1&&!browser.chrome||AppInfo.isNativeApp||(menuOptions.enableHistory=!1),actionsheet.show(menuOptions).then(function(id){var target=targets.filter(function(t){return t.id==id})[0];MediaController.trySetActivePlayer(target.playerName,target),mirrorIfEnabled()})})})):void showActivePlayerMenu(playerInfo)}function showActivePlayerMenu(playerInfo){require(["dialogHelper","dialog","emby-checkbox","emby-button"],function(dialogHelper){showActivePlayerMenuInternal(dialogHelper,playerInfo)})}function showActivePlayerMenuInternal(dialogHelper,playerInfo){var html="",dialogOptions={removeOnClose:!0};dialogOptions.modal=!1,dialogOptions.entryAnimationDuration=160,dialogOptions.exitAnimationDuration=160,dialogOptions.autoFocus=!1;var dlg=dialogHelper.createDialog(dialogOptions);if(dlg.classList.add("promptDialog"),html+='<div class="promptDialogContent" style="padding:1.5em;">',html+='<h2 style="margin-top:.5em;">',html+=playerInfo.deviceName||playerInfo.name,html+="</h2>",html+="<div>",playerInfo.supportedCommands.indexOf("DisplayContent")!=-1){html+='<label class="checkboxContainer">';var checkedHtml=MediaController.enableDisplayMirroring()?" checked":"";html+='<input type="checkbox" is="emby-checkbox" class="chkMirror"'+checkedHtml+"/>",html+="<span>"+Globalize.translate("OptionEnableDisplayMirroring")+"</span>",html+="</label>"}html+="</div>",html+='<div style="margin-top:1em;display:flex;justify-content: flex-end;">',html+='<button is="emby-button" type="button" class="button-flat button-accent-flat btnRemoteControl promptDialogButton">'+Globalize.translate("ButtonRemoteControl")+"</button>",html+='<button is="emby-button" type="button" class="button-flat button-accent-flat btnDisconnect promptDialogButton ">'+Globalize.translate("ButtonDisconnect")+"</button>",html+='<button is="emby-button" type="button" class="button-flat button-accent-flat btnCancel promptDialogButton">'+Globalize.translate("ButtonCancel")+"</button>",html+="</div>",html+="</div>",dlg.innerHTML=html;var chkMirror=dlg.querySelector(".chkMirror");chkMirror&&chkMirror.addEventListener("change",onMirrorChange);var destination="",btnRemoteControl=dlg.querySelector(".btnRemoteControl");btnRemoteControl&&btnRemoteControl.addEventListener("click",function(){destination="nowplaying.html",dialogHelper.close(dlg)}),dlg.querySelector(".btnDisconnect").addEventListener("click",function(){MediaController.disconnectFromPlayer(),dialogHelper.close(dlg)}),dlg.querySelector(".btnCancel").addEventListener("click",function(){dialogHelper.close(dlg)}),dialogHelper.open(dlg).then(function(){destination&&Dashboard.navigate(destination)})}function onMirrorChange(){MediaController.enableDisplayMirroring(this.checked)}function mediaController(){function onBeforePlaybackStart(e,state){events.trigger(self,"beforeplaybackstart",[state,this])}function onPlaybackStop(e,state){events.trigger(self,"playbackstop",[state,this])}function triggerPlayerChange(newPlayer,newTarget,previousPlayer){events.trigger(self,"playerchange",[newPlayer,newTarget,previousPlayer])}function validatePlayback(player){return player.isLocalPlayer?new Promise(function(resolve,reject){requirejs(["registrationServices"],function(registrationServices){self.playbackTimeLimitMs=null,registrationServices.validateFeature("playback").then(resolve,function(){self.playbackTimeLimitMs=lockedTimeLimitMs,startAutoStopTimer(),resolve()})})}):Promise.resolve()}function startAutoStopTimer(){stopAutoStopTimer(),autoStopTimeout=setTimeout(onAutoStopTimeout,lockedTimeLimitMs)}function onAutoStopTimeout(){stopAutoStopTimer(),MediaController.stop()}function stopAutoStopTimer(){var timeout=autoStopTimeout;timeout&&(clearTimeout(timeout),autoStopTimeout=null)}function getPlaybackInfoWithoutLocalMediaSource(itemId,deviceProfile,startPosition,mediaSource,audioStreamIndex,subtitleStreamIndex,liveStreamId,resolve,reject){self.getPlaybackInfoInternal(itemId,deviceProfile,startPosition,mediaSource,audioStreamIndex,subtitleStreamIndex,liveStreamId).then(resolve,reject)}var currentPlayer,currentTargetInfo,self=this,players=[];self.registerPlayer=function(player){players.push(player),player.isLocalPlayer&&monitorPlayer(player),events.on(player,"playbackstop",onPlaybackStop),events.on(player,"beforeplaybackstart",onBeforePlaybackStart)},self.getPlayerInfo=function(){var player=currentPlayer||{},target=currentTargetInfo||{};return{name:player.name,isLocalPlayer:player.isLocalPlayer,id:target.id,deviceName:target.deviceName,playableMediaTypes:target.playableMediaTypes,supportedCommands:target.supportedCommands}},self.setActivePlayer=function(player,targetInfo){if("string"==typeof player&&(player=players.filter(function(p){return p.name==player})[0]),!player)throw new Error("null player");var previousPlayer=currentPlayer;currentPairingId=null,currentPlayer=player,currentTargetInfo=targetInfo,console.log("Active player: "+JSON.stringify(currentTargetInfo)),triggerPlayerChange(player,targetInfo,previousPlayer)};var currentPairingId=null;self.trySetActivePlayer=function(player,targetInfo){if("string"==typeof player&&(player=players.filter(function(p){return p.name==player})[0]),!player)throw new Error("null player");currentPairingId!=targetInfo.id&&(currentPairingId=targetInfo.id,player.tryPair(targetInfo).then(function(){var previousPlayer=currentPlayer;currentPlayer=player,currentTargetInfo=targetInfo,console.log("Active player: "+JSON.stringify(currentTargetInfo)),triggerPlayerChange(player,targetInfo,previousPlayer)},function(){currentPairingId==targetInfo.id&&(currentPairingId=null)}))},self.trySetActiveDeviceName=function(name){function normalizeName(t){return t.toLowerCase().replace(" ","")}name=normalizeName(name),self.getTargets().then(function(result){var target=result.filter(function(p){return normalizeName(p.name)==name})[0];target&&self.trySetActivePlayer(target.playerName,target)})},self.setDefaultPlayerActive=function(){var player=self.getDefaultPlayer();player.getTargets().then(function(targets){self.setActivePlayer(player,targets[0])})},self.removeActivePlayer=function(name){self.getPlayerInfo().name==name&&self.setDefaultPlayerActive()},self.removeActiveTarget=function(id){self.getPlayerInfo().id==id&&self.setDefaultPlayerActive()},self.disconnectFromPlayer=function(){var playerInfo=self.getPlayerInfo();playerInfo.supportedCommands.indexOf("EndSession")!=-1?require(["dialog"],function(dialog){var menuItems=[];menuItems.push({name:Globalize.translate("ButtonYes"),id:"yes"}),menuItems.push({name:Globalize.translate("ButtonNo"),id:"no"}),dialog({buttons:menuItems,text:Globalize.translate("ConfirmEndPlayerSession")}).then(function(id){switch(id){case"yes":MediaController.getCurrentPlayer().endSession(),self.setDefaultPlayerActive();break;case"no":self.setDefaultPlayerActive()}})}):self.setDefaultPlayerActive()},self.getPlayers=function(){return players},self.getTargets=function(){var promises=players.map(function(p){return p.getTargets()});return Promise.all(promises).then(function(responses){for(var targets=[],i=0;i<responses.length;i++)for(var subTargets=responses[i],j=0;j<subTargets.length;j++)targets.push(subTargets[j]);return targets=targets.sort(function(a,b){var aVal=a.isLocalPlayer?0:1,bVal=b.isLocalPlayer?0:1;return aVal=aVal.toString()+a.name,bVal=bVal.toString()+b.name,aVal.localeCompare(bVal)})})};var autoStopTimeout,lockedTimeLimitMs=6e4;self.toggleDisplayMirroring=function(){self.enableDisplayMirroring(!self.enableDisplayMirroring())},self.enableDisplayMirroring=function(enabled){if(null!=enabled){var val=enabled?"1":"0";return appSettings.set("displaymirror--"+Dashboard.getCurrentUserId(),val),void(enabled&&mirrorIfEnabled())}return"0"!=(appSettings.get("displaymirror--"+Dashboard.getCurrentUserId())||"")},self.play=function(options){return options.enableRemotePlayers!==!1||currentPlayer.isLocalPlayer?validatePlayback(currentPlayer).then(function(){return"string"==typeof options&&(options={ids:[options]}),currentPlayer.play(options)}):Promise.reject()},self.shuffle=function(id){id.Id&&(id=id.Id),validatePlayback(currentPlayer).then(function(){currentPlayer.shuffle(id)})},self.instantMix=function(id){id.Id&&(id=id.Id),validatePlayback(currentPlayer).then(function(){currentPlayer.instantMix(id)})},self.queue=function(options){"string"==typeof options&&(options={ids:[options]}),currentPlayer.queue(options)},self.queueNext=function(options){"string"==typeof options&&(options={ids:[options]}),currentPlayer.queueNext(options)},self.canPlay=function(item){return"Program"==item.Type?!((new Date).getTime()>datetime.parseISO8601Date(item.EndDate).getTime()||(new Date).getTime()<datetime.parseISO8601Date(item.StartDate).getTime()):self.canPlayByAttributes(item.Type,item.MediaType,item.PlayAccess,item.LocationType)},self.canPlayByAttributes=function(itemType,mediaType,playAccess,locationType){return"Full"==playAccess&&("Virtual"!=locationType&&("Program"!=itemType&&("MusicGenre"==itemType||"Season"==itemType||"Series"==itemType||"BoxSet"==itemType||"MusicAlbum"==itemType||"MusicArtist"==itemType||"Playlist"==itemType||self.getPlayerInfo().playableMediaTypes.indexOf(mediaType)!=-1)))},self.canQueueMediaType=function(mediaType,itemType){return"MusicAlbum"!=itemType&&"MusicArtist"!=itemType&&"MusicGenre"!=itemType||(mediaType="Audio"),currentPlayer.canQueueMediaType(mediaType)},self.getLocalPlayer=function(){return currentPlayer.isLocalPlayer?currentPlayer:players.filter(function(p){return p.isLocalPlayer})[0]},self.getDefaultPlayer=function(){return currentPlayer.isLocalPlayer?currentPlayer:players.filter(function(p){return p.isDefaultPlayer})[0]},self.getCurrentPlayer=function(){return currentPlayer},self.pause=function(){currentPlayer.pause()},self.stop=function(){currentPlayer.stop()},self.unpause=function(){currentPlayer.unpause()},self.seek=function(position){currentPlayer.seek(position)},self.currentPlaylistIndex=function(i){return null==i?currentPlayer.currentPlaylistIndex?currentPlayer.currentPlaylistIndex():-1:void currentPlayer.currentPlaylistIndex(i)},self.removeFromPlaylist=function(i){currentPlayer.removeFromPlaylist(i)},self.nextTrack=function(){currentPlayer.nextTrack()},self.previousTrack=function(){currentPlayer.previousTrack()},self.mute=function(){currentPlayer.mute()},self.unMute=function(){currentPlayer.unMute()},self.toggleMute=function(){currentPlayer.toggleMute()},self.volumeDown=function(){currentPlayer.volumeDown()},self.volumeUp=function(){currentPlayer.volumeUp()},self.setRepeatMode=function(mode){currentPlayer.setRepeatMode(mode)},self.playlist=function(){return currentPlayer.playlist||[]},self.sendCommand=function(cmd,player){switch(player=player||self.getLocalPlayer(),console.log("MediaController received command: "+cmd.Name),cmd.Name){case"SetRepeatMode":player.setRepeatMode(cmd.Arguments.RepeatMode);break;case"VolumeUp":player.volumeUp();break;case"VolumeDown":player.volumeDown();break;case"Mute":player.mute();break;case"Unmute":player.unMute();break;case"ToggleMute":player.toggleMute();break;case"SetVolume":player.setVolume(cmd.Arguments.Volume);break;case"SetAudioStreamIndex":player.setAudioStreamIndex(parseInt(cmd.Arguments.Index));break;case"SetSubtitleStreamIndex":player.setSubtitleStreamIndex(parseInt(cmd.Arguments.Index));break;case"ToggleFullscreen":player.toggleFullscreen();break;default:player.isLocalPlayer||player.sendCommand(cmd)}},self.getNowPlayingNames=function(nowPlayingItem,includeNonNameInfo){var topItem=nowPlayingItem,bottomItem=null,topText=nowPlayingItem.Name;nowPlayingItem.AlbumId&&"Audio"==nowPlayingItem.MediaType&&(topItem={Id:nowPlayingItem.AlbumId,Name:nowPlayingItem.Album,Type:"MusicAlbum",IsFolder:!0}),"Video"==nowPlayingItem.MediaType&&(null!=nowPlayingItem.IndexNumber&&(topText=nowPlayingItem.IndexNumber+" - "+topText),null!=nowPlayingItem.ParentIndexNumber&&(topText=nowPlayingItem.ParentIndexNumber+"."+topText));var bottomText="";nowPlayingItem.Artists&&nowPlayingItem.Artists.length?nowPlayingItem.ArtistItems&&nowPlayingItem.ArtistItems.length?(bottomItem={Id:nowPlayingItem.ArtistItems[0].Id,Name:nowPlayingItem.ArtistItems[0].Name,Type:"MusicArtist",IsFolder:!0},bottomText=bottomItem.Name):bottomText=nowPlayingItem.Artists[0]:nowPlayingItem.SeriesName||nowPlayingItem.Album?(bottomText=topText,topText=nowPlayingItem.SeriesName||nowPlayingItem.Album,bottomItem=topItem,topItem=nowPlayingItem.SeriesId?{Id:nowPlayingItem.SeriesId,Name:nowPlayingItem.SeriesName,Type:"Series",IsFolder:!0}:null):nowPlayingItem.ProductionYear&&includeNonNameInfo!==!1&&(bottomText=nowPlayingItem.ProductionYear);var list=[];return list.push({text:topText,item:topItem}),bottomText&&list.push({text:bottomText,item:bottomItem}),list},self.getNowPlayingNameHtml=function(nowPlayingItem,includeNonNameInfo){var names=self.getNowPlayingNames(nowPlayingItem,includeNonNameInfo);return names.map(function(i){return i.text}).join("<br/>")},self.showPlaybackInfoErrorMessage=function(errorCode){require(["alert"],function(alert){alert({title:Globalize.translate("HeaderPlaybackError"),text:Globalize.translate("MessagePlaybackError"+errorCode),type:"error"})})},self.getPlaybackInfo=function(itemId,deviceProfile,startPosition,mediaSource,audioStreamIndex,subtitleStreamIndex,liveStreamId){return new Promise(function(resolve,reject){require([],function(){ApiClient.serverInfo();getPlaybackInfoWithoutLocalMediaSource(itemId,deviceProfile,startPosition,mediaSource,audioStreamIndex,subtitleStreamIndex,liveStreamId,resolve,reject)})})},self.getPlaybackInfoInternal=function(itemId,deviceProfile,startPosition,mediaSource,audioStreamIndex,subtitleStreamIndex,liveStreamId){var postData={DeviceProfile:deviceProfile},query={UserId:Dashboard.getCurrentUserId(),StartTimeTicks:startPosition||0};return null!=audioStreamIndex&&(query.AudioStreamIndex=audioStreamIndex),null!=subtitleStreamIndex&&(query.SubtitleStreamIndex=subtitleStreamIndex),mediaSource&&(query.MediaSourceId=mediaSource.Id),liveStreamId&&(query.LiveStreamId=liveStreamId),ApiClient.ajax({url:ApiClient.getUrl("Items/"+itemId+"/PlaybackInfo",query),type:"POST",data:JSON.stringify(postData),contentType:"application/json",dataType:"json"})},self.getLiveStream=function(itemId,playSessionId,deviceProfile,startPosition,mediaSource,audioStreamIndex,subtitleStreamIndex){var postData={DeviceProfile:deviceProfile,OpenToken:mediaSource.OpenToken},query={UserId:Dashboard.getCurrentUserId(),StartTimeTicks:startPosition||0,ItemId:itemId,PlaySessionId:playSessionId};return null!=audioStreamIndex&&(query.AudioStreamIndex=audioStreamIndex),null!=subtitleStreamIndex&&(query.SubtitleStreamIndex=subtitleStreamIndex),ApiClient.ajax({url:ApiClient.getUrl("LiveStreams/Open",query),type:"POST",data:JSON.stringify(postData),contentType:"application/json",dataType:"json"})},self.supportsDirectPlay=function(mediaSource,itemType){return new Promise(function(resolve,reject){if(mediaSource.SupportsDirectPlay){if("Http"==mediaSource.Protocol&&!mediaSource.RequiredHttpHeaders.length)if(mediaSource.SupportsDirectStream||mediaSource.SupportsTranscoding){var val=0==mediaSource.Path.toLowerCase().replace("https:","http").indexOf(ApiClient.serverAddress().toLowerCase().replace("https:","http").substring(0,14));resolve(val)}else resolve(!0);"File"==mediaSource.Protocol&&require(["filesystem"],function(fileSystem){fileSystem.fileExists(mediaSource.Path).then(function(){console.log("fileSystem.fileExists: path: "+mediaSource.Path+" result: "+!0),resolve(!0)},function(){console.log("fileSystem.fileExists: path: "+mediaSource.Path+" result: "+!1),resolve(!1)})})}else resolve(!1)})},self.showPlayerSelection=showPlayerSelection}function onWebSocketMessageReceived(e,msg){"ServerShuttingDown"===msg.MessageType?MediaController.setDefaultPlayerActive():"ServerRestarting"===msg.MessageType&&MediaController.setDefaultPlayerActive()}function initializeApiClient(apiClient){events.off(apiClient,"websocketmessage",onWebSocketMessageReceived),events.on(apiClient,"websocketmessage",onWebSocketMessageReceived)}function onCastButtonClicked(){showPlayerSelection(this)}var currentDisplayInfo,datetime;window.MediaController=new mediaController,MediaController.init=function(){console.log("Beginning MediaController.init"),require(["datetime"],function(datetimeInstance){datetime=datetimeInstance}),window.ApiClient&&initializeApiClient(window.ApiClient),events.on(ConnectionManager,"apiclientcreated",function(e,apiClient){initializeApiClient(apiClient)})},document.addEventListener("headercreated",function(){var btnCast=document.querySelector(".viewMenuBar .btnCast");btnCast.removeEventListener("click",onCastButtonClicked),btnCast.addEventListener("click",onCastButtonClicked)}),pageClassOn("pagebeforeshow","page",function(){currentDisplayInfo=null}),pageClassOn("displayingitem","libraryPage",function(e){var info=e.detail;mirrorIfEnabled(info)})});
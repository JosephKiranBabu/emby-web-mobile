define(["datetime","userdataButtons","itemHelper","events","browser","paper-icon-button-light"],function(datetime,userdataButtons,itemHelper,events,browser){function getNowPlayingBarHtml(){var html="";return html+='<div class="nowPlayingBar hide">',html+='<div class="nowPlayingBarTop">',html+='<div class="nowPlayingBarPositionContainer sliderContainer">',html+='<input type="range" is="emby-slider" pin step=".1" min="0" max="100" value="0" class="nowPlayingBarPositionSlider"/>',html+="</div>",html+='<div class="nowPlayingBarInfoContainer">',html+='<div class="nowPlayingImage"></div>',html+='<div class="nowPlayingBarText"></div>',html+="</div>",html+='<div class="nowPlayingBarCenter">',html+='<button is="paper-icon-button-light" class="previousTrackButton mediaButton autoSize"><i class="md-icon">skip_previous</i></button>',html+='<button is="paper-icon-button-light" class="unpauseButton mediaButton autoSize"><i class="md-icon">play_arrow</i></button>',html+='<button is="paper-icon-button-light" class="pauseButton mediaButton autoSize"><i class="md-icon">pause</i></button>',html+='<button is="paper-icon-button-light" class="stopButton mediaButton autoSize"><i class="md-icon">stop</i></button>',html+='<button is="paper-icon-button-light" class="nextTrackButton mediaButton autoSize"><i class="md-icon">skip_next</i></button>',html+='<div class="nowPlayingBarCurrentTime"></div>',html+="</div>",html+='<div class="nowPlayingBarRight">',html+='<button is="paper-icon-button-light" class="muteButton mediaButton autoSize"><i class="md-icon">volume_up</i></button>',html+='<button is="paper-icon-button-light" class="unmuteButton mediaButton autoSize"><i class="md-icon">volume_off</i></button>',html+='<div class="sliderContainer nowPlayingBarVolumeSliderContainer hide" style="width:100px;vertical-align:middle;display:inline-flex;">',html+='<input type="range" is="emby-slider" pin step="1" min="0" max="100" value="0" class="nowPlayingBarVolumeSlider"/>',html+="</div>",html+='<button is="paper-icon-button-light" class="toggleRepeatButton mediaButton autoSize"><i class="md-icon">repeat</i></button>',html+='<div class="nowPlayingBarUserDataButtons">',html+="</div>",html+='<button is="paper-icon-button-light" class="unpauseButton mediaButton autoSize"><i class="md-icon">play_arrow</i></button>',html+='<button is="paper-icon-button-light" class="pauseButton mediaButton autoSize"><i class="md-icon">pause</i></button>',html+='<button is="paper-icon-button-light" class="remoteControlButton mediaButton autoSize"><i class="md-icon">tablet_android</i></button>',html+='<button is="paper-icon-button-light" class="playlistButton mediaButton autoSize"><i class="md-icon">queue_music</i></button>',html+="</div>",html+="</div>",html+="</div>"}function slideDown(elem){if(!elem.classList.contains("hide")){var onfinish=function(){elem.classList.add("hide")};return!browser.animate||browser.slow?void onfinish():void requestAnimationFrame(function(){var keyframes=[{transform:"none",offset:0},{transform:"translateY(100%)",offset:1}],timing={duration:200,iterations:1,fill:"both",easing:"ease-out"};elem.animate(keyframes,timing).onfinish=onfinish})}}function slideUp(elem){elem.classList.contains("hide")&&(elem.classList.remove("hide"),browser.animate&&!browser.slow&&requestAnimationFrame(function(){var keyframes=[{transform:"translateY(100%)",offset:0},{transform:"none",offset:1}],timing={duration:200,iterations:1,fill:"both",easing:"ease-out"};elem.animate(keyframes,timing)}))}function onPauseClick(){currentPlayer&&currentPlayer.pause()}function onUnpauseClick(){currentPlayer&&currentPlayer.unpause()}function bindEvents(elem){currentTimeElement=elem.querySelector(".nowPlayingBarCurrentTime"),nowPlayingImageElement=elem.querySelector(".nowPlayingImage"),nowPlayingTextElement=elem.querySelector(".nowPlayingBarText"),nowPlayingUserData=elem.querySelector(".nowPlayingBarUserDataButtons"),unmuteButton=elem.querySelector(".unmuteButton"),unmuteButton.addEventListener("click",function(){currentPlayer&&currentPlayer.unMute()}),muteButton=elem.querySelector(".muteButton"),muteButton.addEventListener("click",function(){currentPlayer&&currentPlayer.mute()}),elem.querySelector(".stopButton").addEventListener("click",function(){currentPlayer&&currentPlayer.stop()});var i,length;for(pauseButtons=elem.querySelectorAll(".pauseButton"),i=0,length=pauseButtons.length;i<length;i++)pauseButtons[i].addEventListener("click",onPauseClick);for(unpauseButtons=elem.querySelectorAll(".unpauseButton"),i=0,length=unpauseButtons.length;i<length;i++)unpauseButtons[i].addEventListener("click",onUnpauseClick);elem.querySelector(".nextTrackButton").addEventListener("click",function(){currentPlayer&&currentPlayer.nextTrack()}),elem.querySelector(".previousTrackButton").addEventListener("click",function(){currentPlayer&&currentPlayer.previousTrack()}),elem.querySelector(".remoteControlButton").addEventListener("click",function(){showRemoteControl()}),elem.querySelector(".playlistButton").addEventListener("click",function(){showRemoteControl(2)}),toggleRepeatButton=elem.querySelector(".toggleRepeatButton"),toggleRepeatButton.addEventListener("click",function(){if(currentPlayer){var state=lastPlayerState||{};switch((state.PlayState||{}).RepeatMode){case"RepeatAll":currentPlayer.setRepeatMode("RepeatOne");break;case"RepeatOne":currentPlayer.setRepeatMode("RepeatNone");break;default:currentPlayer.setRepeatMode("RepeatAll")}}}),toggleRepeatButtonIcon=toggleRepeatButton.querySelector("i"),volumeSlider=elem.querySelector(".nowPlayingBarVolumeSlider"),volumeSliderContainer=elem.querySelector(".nowPlayingBarVolumeSliderContainer"),AppInfo.hasPhysicalVolumeButtons?volumeSliderContainer.classList.add("hide"):volumeSliderContainer.classList.remove("hide"),volumeSlider.addEventListener("change",function(){currentPlayer&&currentPlayer.setVolume(this.value)}),positionSlider=elem.querySelector(".nowPlayingBarPositionSlider"),positionSlider.addEventListener("change",function(){if(currentPlayer&&lastPlayerState){var newPercent=parseFloat(this.value),newPositionTicks=newPercent/100*lastPlayerState.NowPlayingItem.RunTimeTicks;currentPlayer.seek(Math.floor(newPositionTicks))}}),positionSlider.getBubbleText=function(value){var state=lastPlayerState;if(!state||!state.NowPlayingItem||!state.NowPlayingItem.RunTimeTicks)return"--:--";var ticks=state.NowPlayingItem.RunTimeTicks;return ticks/=100,ticks*=value,datetime.getDisplayRunningTime(ticks)}}function showRemoteControl(tabIndex){tabIndex?Dashboard.navigate("nowplaying.html?tab="+tabIndex):Dashboard.navigate("nowplaying.html")}function getNowPlayingBar(){return nowPlayingBarElement?Promise.resolve(nowPlayingBarElement):new Promise(function(resolve,reject){require(["appfooter-shared","itemShortcuts","css!css/nowplayingbar.css","emby-slider"],function(appfooter,itemShortcuts){var parentContainer=appfooter.element;return(nowPlayingBarElement=parentContainer.querySelector(".nowPlayingBar"))?void resolve(nowPlayingBarElement):(parentContainer.insertAdjacentHTML("afterbegin",getNowPlayingBarHtml()),nowPlayingBarElement=parentContainer.querySelector(".nowPlayingBar"),browser.safari&&browser.slow&&nowPlayingBarElement.classList.add("noMediaProgress"),itemShortcuts.on(nowPlayingBarElement),bindEvents(nowPlayingBarElement),void resolve(nowPlayingBarElement))})})}function showButton(button){button.classList.remove("hide")}function hideButton(button){button.classList.add("hide")}function updatePlayerState(event,state){return state.NowPlayingItem?nowPlayingBarElement?void updatePlayerStateInternal(event,state):void getNowPlayingBar().then(function(){updatePlayerStateInternal(event,state)}):void hideNowPlayingBar()}function updatePlayerStateInternal(event,state){if(showNowPlayingBar(),"positionchange"==event.type){var now=(new Date).getTime();if(now-lastUpdateTime<700)return;lastUpdateTime=now}lastPlayerState=state;var i,length,playerInfo=MediaController.getPlayerInfo(),playState=state.PlayState||{};if(playState.IsPaused){for(i=0,length=pauseButtons.length;i<length;i++)hideButton(pauseButtons[i]);for(i=0,length=unpauseButtons.length;i<length;i++)showButton(unpauseButtons[i])}else{for(i=0,length=pauseButtons.length;i<length;i++)showButton(pauseButtons[i]);for(i=0,length=unpauseButtons.length;i<length;i++)hideButton(unpauseButtons[i])}updatePlayerVolumeState(state,playerInfo);var nowPlayingItem=state.NowPlayingItem||{};if(positionSlider&&!positionSlider.dragging){if(nowPlayingItem.RunTimeTicks){var pct=playState.PositionTicks/nowPlayingItem.RunTimeTicks;pct*=100,positionSlider.value=pct}else positionSlider.value=0;positionSlider.disabled=!playState.CanSeek}var timeText=null==playState.PositionTicks?"--:--":datetime.getDisplayRunningTime(playState.PositionTicks);nowPlayingItem.RunTimeTicks&&(timeText+=" / "+datetime.getDisplayRunningTime(nowPlayingItem.RunTimeTicks)),currentTimeElement.innerHTML=timeText,updateNowPlayingInfo(state)}function updatePlayerVolumeState(state,playerInfo){playerInfo=playerInfo||MediaController.getPlayerInfo();var playState=state.PlayState||{},supportedCommands=playerInfo.supportedCommands,showMuteButton=!0,showUnmuteButton=!0,showVolumeSlider=!0;supportedCommands.indexOf("Mute")==-1&&(showMuteButton=!1),supportedCommands.indexOf("Unmute")==-1&&(showUnmuteButton=!1),playState.IsMuted?showMuteButton=!1:showUnmuteButton=!1,supportedCommands.indexOf("SetRepeatMode")==-1?toggleRepeatButton.classList.add("hide"):toggleRepeatButton.classList.remove("hide"),"RepeatAll"==playState.RepeatMode?(toggleRepeatButtonIcon.innerHTML="repeat",toggleRepeatButton.classList.add("repeatActive")):"RepeatOne"==playState.RepeatMode?(toggleRepeatButtonIcon.innerHTML="repeat_one",toggleRepeatButton.classList.add("repeatActive")):(toggleRepeatButtonIcon.innerHTML="repeat",toggleRepeatButton.classList.remove("repeatActive")),supportedCommands.indexOf("SetVolume")==-1&&(showVolumeSlider=!1),playerInfo.isLocalPlayer&&AppInfo.hasPhysicalVolumeButtons&&(showMuteButton=!1,showUnmuteButton=!1,showVolumeSlider=!1),showMuteButton?showButton(muteButton):hideButton(muteButton),showUnmuteButton?showButton(unmuteButton):hideButton(unmuteButton),volumeSlider&&(showVolumeSlider?volumeSliderContainer.classList.remove("hide"):volumeSliderContainer.classList.add("hide"),volumeSlider.dragging||(volumeSlider.value=playState.VolumeLevel||0))}function getTextActionButton(item,text){text||(text=itemHelper.getDisplayName(item));var html='<button data-id="'+item.Id+'" data-type="'+item.Type+'" data-mediatype="'+item.MediaType+'" data-channelid="'+item.ChannelId+'" data-isfolder="'+item.IsFolder+'" type="button" class="itemAction textActionButton" data-action="link">';return html+=text,html+="</button>"}function updateNowPlayingInfo(state){nowPlayingTextElement.innerHTML=MediaController.getNowPlayingNames(state.NowPlayingItem).map(function(nowPlayingName){return nowPlayingName.item?"<div>"+getTextActionButton(nowPlayingName.item,nowPlayingName.text)+"</div>":"<div>"+nowPlayingName.text+"</div>"}).join("");var url,imgHeight=70,nowPlayingItem=state.NowPlayingItem;url=nowPlayingItem.PrimaryImageTag?ApiClient.getScaledImageUrl(nowPlayingItem.PrimaryImageItemId,{type:"Primary",height:imgHeight,tag:nowPlayingItem.PrimaryImageTag}):nowPlayingItem.BackdropImageTag?ApiClient.getScaledImageUrl(nowPlayingItem.BackdropItemId,{type:"Backdrop",height:imgHeight,tag:nowPlayingItem.BackdropImageTag,index:0}):nowPlayingItem.ThumbImageTag?ApiClient.getScaledImageUrl(nowPlayingItem.ThumbImageItemId,{type:"Thumb",height:imgHeight,tag:nowPlayingItem.ThumbImageTag}):"TvChannel"==nowPlayingItem.Type||"Recording"==nowPlayingItem.Type?"css/images/items/detail/tv.png":"Audio"==nowPlayingItem.MediaType?"css/images/items/detail/audio.png":"css/images/items/detail/video.png",url!=currentImgUrl&&(currentImgUrl=url,ImageLoader.lazyImage(nowPlayingImageElement,url),nowPlayingItem.Id?ApiClient.getItem(Dashboard.getCurrentUserId(),nowPlayingItem.Id).then(function(item){userdataButtons.fill({item:item,includePlayed:!1,element:nowPlayingUserData})}):userdataButtons.destroy({element:nowPlayingUserData}))}function onPlaybackStart(e,state){console.log("nowplaying event: "+e.type);var player=this;player.beginPlayerUpdates(),onStateChanged.call(player,e,state)}function showNowPlayingBar(){getNowPlayingBar().then(slideUp)}function hideNowPlayingBar(){var elem=document.getElementsByClassName("nowPlayingBar")[0];elem&&slideDown(elem)}function onPlaybackStopped(e,state){console.log("nowplaying event: "+e.type);var player=this;player.endPlayerUpdates(),hideNowPlayingBar()}function onStateChanged(e,state){var player=this;player.isDefaultPlayer&&state.NowPlayingItem&&"Video"==state.NowPlayingItem.MediaType||updatePlayerState(e,state)}function releaseCurrentPlayer(){currentPlayer&&(events.off(currentPlayer,"playbackstart",onPlaybackStart),events.off(currentPlayer,"playbackstop",onPlaybackStopped),events.off(currentPlayer,"volumechange",onVolumeChanged),events.off(currentPlayer,"playstatechange",onStateChanged),events.off(currentPlayer,"positionchange",onStateChanged),currentPlayer.endPlayerUpdates(),currentPlayer=null,hideNowPlayingBar())}function onVolumeChanged(e){var player=this;Promise.all([player.getPlayerState(),getNowPlayingBar()]).then(function(responses){var state=responses[0];player.isDefaultPlayer&&state.NowPlayingItem&&"Video"==state.NowPlayingItem.MediaType||updatePlayerVolumeState(state)})}function bindToPlayer(player){releaseCurrentPlayer(),currentPlayer=player,player.getPlayerState().then(function(state){state.NowPlayingItem&&player.beginPlayerUpdates(),onStateChanged.call(player,{type:"init"},state)}),events.on(player,"playbackstart",onPlaybackStart),events.on(player,"playbackstop",onPlaybackStopped),events.on(player,"volumechange",onVolumeChanged),events.on(player,"playstatechange",onStateChanged),events.on(player,"positionchange",onStateChanged)}var currentPlayer,currentTimeElement,nowPlayingImageElement,nowPlayingTextElement,nowPlayingUserData,unmuteButton,muteButton,volumeSlider,volumeSliderContainer,unpauseButtons,pauseButtons,positionSlider,toggleRepeatButton,toggleRepeatButtonIcon,lastPlayerState,nowPlayingBarElement,currentImgUrl,lastUpdateTime=0;events.on(MediaController,"playerchange",function(){bindToPlayer(MediaController.getCurrentPlayer())}),bindToPlayer(MediaController.getCurrentPlayer())});
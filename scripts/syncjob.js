define(["datetime","dom","listViewStyle","paper-icon-button-light","emby-button"],function(datetime,dom){function renderJob(page,job,dialogOptions){var html="";html+="<div>",html+=Globalize.translate("ValueDateCreated",datetime.parseISO8601Date(job.DateCreated,!0).toLocaleString()),html+="</div>",html+="<br/>",html+='<div class="formFields"></div>',html+="<br/>",html+="<br/>",html+='<button is="emby-button" type="submit" class="raised button-submit block"><span>'+Globalize.translate("ButtonSave")+"</span></button>",page.querySelector(".syncJobForm").innerHTML=html,require(["syncDialog"],function(syncDialog){syncDialog.renderForm({elem:page.querySelector(".formFields"),dialogOptions:dialogOptions,dialogOptionsFn:getTargetDialogOptionsFn(dialogOptions),showName:!0,readOnlySyncTarget:!0}).then(function(){fillJobValues(page,job,dialogOptions)})})}function getTargetDialogOptionsFn(dialogOptions){return function(targetId){return Promise.resolve(dialogOptions)}}function getJobItemHtml(jobItem,index){var html="";html+='<div class="listItem" data-itemid="'+jobItem.Id+'" data-status="'+jobItem.Status+'" data-remove="'+jobItem.IsMarkedForRemoval+'">';var imgUrl,hasActions=["Queued","Cancelled","Failed","ReadyToTransfer","Transferring","Converting","Synced"].indexOf(jobItem.Status)!=-1;return jobItem.PrimaryImageItemId&&(imgUrl=ApiClient.getImageUrl(jobItem.PrimaryImageItemId,{type:"Primary",width:80,tag:jobItem.PrimaryImageTag,minScale:1.5})),html+=imgUrl?'<button type="button" is="emby-button" class="blue mini fab autoSize" icon="sync" style="background-image:url(\''+imgUrl+'\');background-repeat:no-repeat;background-position:center center;background-size: cover;"><i style="visibility:hidden;" class="md-icon">sync</i></button>':'<button type="button" is="emby-button" class="blue mini fab autoSize" icon="sync"><i class="md-icon">sync</i></button>',html+='<div class="listItemBody three-line">',html+="<div>",html+=jobItem.ItemName,html+="</div>",html+="Failed"==jobItem.Status?'<div class="secondary" style="color:red;">':'<div class="secondary">',html+=Globalize.translate("SyncJobItemStatus"+jobItem.Status),"Synced"==jobItem.Status&&jobItem.IsMarkedForRemoval&&(html+="<br/>",html+=Globalize.translate("SyncJobItemStatusSyncedMarkForRemoval")),html+="</div>",html+='<div class="secondary" style="padding-top:5px;">',html+='<div style="background:#e0e0e0;height:4px;"><div style="background:#52B54B;width:'+(jobItem.Progress||0)+'%;height:100%;"></div></div>',html+="</div>",html+="</div>",html+=hasActions?'<button type="button" is="paper-icon-button-light" class="btnJobItemMenu autoSize"><i class="md-icon">'+AppInfo.moreIcon.replace("-","_")+"</i></button>":'<button type="button" is="paper-icon-button-light" class="btnJobItemMenu autoSize" disabled><i class="md-icon">'+AppInfo.moreIcon.replace("-","_")+"</i></button>",html+="</div>"}function renderJobItems(page,items){var html="";html+="<h1>"+Globalize.translate("HeaderItems")+"</h1>",html+='<div class="paperList">';var index=0;html+=items.map(function(i){return getJobItemHtml(i,index++)}).join(""),html+="</div>";var elem=page.querySelector(".jobItems");elem.innerHTML=html,ImageLoader.lazyChildren(elem)}function parentWithClass(elem,className){for(;!elem.classList||!elem.classList.contains(className);)if(elem=elem.parentNode,!elem)return null;return elem}function showJobItemMenu(elem){var page=parentWithClass(elem,"page"),listItem=parentWithClass(elem,"listItem"),jobItemId=listItem.getAttribute("data-itemid"),status=listItem.getAttribute("data-status"),remove="true"==listItem.getAttribute("data-remove").toLowerCase(),menuItems=[];"Failed"==status?menuItems.push({name:Globalize.translate("ButtonQueueForRetry"),id:"retry"}):"Cancelled"==status?menuItems.push({name:Globalize.translate("ButtonReenable"),id:"retry"}):"Queued"==status||"Transferring"==status||"Converting"==status||"ReadyToTransfer"==status?menuItems.push({name:Globalize.translate("ButtonCancelItem"),id:"cancel"}):"Synced"==status&&remove?menuItems.push({name:Globalize.translate("ButtonUnmarkForRemoval"),id:"unmarkforremoval"}):"Synced"==status&&menuItems.push({name:Globalize.translate("ButtonMarkForRemoval"),id:"markforremoval"}),require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:elem,callback:function(id){switch(id){case"cancel":cancelJobItem(page,jobItemId);break;case"retry":retryJobItem(page,jobItemId);break;case"markforremoval":markForRemoval(page,jobItemId);break;case"unmarkforremoval":unMarkForRemoval(page,jobItemId)}}})})}function cancelJobItem(page,jobItemId){Dashboard.showLoadingMsg(),ApiClient.ajax({type:"DELETE",url:ApiClient.getUrl("Sync/JobItems/"+jobItemId)}).then(function(){loadJob(page)})}function markForRemoval(page,jobItemId){ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Sync/JobItems/"+jobItemId+"/MarkForRemoval")}).then(function(){loadJob(page)})}function unMarkForRemoval(page,jobItemId){ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Sync/JobItems/"+jobItemId+"/UnmarkForRemoval")}).then(function(){loadJob(page)})}function retryJobItem(page,jobItemId){ApiClient.ajax({type:"POST",url:ApiClient.getUrl("Sync/JobItems/"+jobItemId+"/Enable")}).then(function(){loadJob(page)})}function fillJobValues(page,job,editOptions){var txtSyncJobName=page.querySelector("#txtSyncJobName");txtSyncJobName&&(txtSyncJobName.value=job.Name);var selectProfile=page.querySelector("#selectProfile");selectProfile&&(selectProfile.value=job.Profile||"");var selectQuality=page.querySelector("#selectQuality");selectQuality&&(selectQuality.value=job.Quality||"");var chkUnwatchedOnly=page.querySelector("#chkUnwatchedOnly");chkUnwatchedOnly&&(chkUnwatchedOnly.checked=job.UnwatchedOnly);var chkSyncNewContent=page.querySelector("#chkSyncNewContent");chkSyncNewContent&&(chkSyncNewContent.checked=job.SyncNewContent);var txtItemLimit=page.querySelector("#txtItemLimit");txtItemLimit&&(txtItemLimit.value=job.ItemLimit);var txtBitrate=page.querySelector("#txtBitrate");job.Bitrate?txtBitrate.value=job.Bitrate/1e6:txtBitrate.value="";var target=editOptions.Targets.filter(function(t){return t.Id==job.TargetId})[0],targetName=target?target.Name:"",selectSyncTarget=page.querySelector("#selectSyncTarget");selectSyncTarget&&(selectSyncTarget.value=targetName)}function loadJob(page){Dashboard.showLoadingMsg();var id=getParameterByName("id");ApiClient.getJSON(ApiClient.getUrl("Sync/Jobs/"+id)).then(function(job){ApiClient.getJSON(ApiClient.getUrl("Sync/Options",{UserId:job.UserId,ItemIds:job.RequestedItemIds&&job.RequestedItemIds.length?job.RequestedItemIds.join(""):null,ParentId:job.ParentId,Category:job.Category,TargetId:job.TargetId})).then(function(options){_jobOptions=options,renderJob(page,job,options),Dashboard.hideLoadingMsg()})}),ApiClient.getJSON(ApiClient.getUrl("Sync/JobItems",{JobId:id,AddMetadata:!0})).then(function(result){renderJobItems(page,result.Items),Dashboard.hideLoadingMsg()})}function loadJobInfo(page,job,jobItems){renderJobItems(page,jobItems),Dashboard.hideLoadingMsg()}function saveJob(page){Dashboard.showLoadingMsg();var id=getParameterByName("id");ApiClient.getJSON(ApiClient.getUrl("Sync/Jobs/"+id)).then(function(job){require(["syncDialog"],function(syncDialog){syncDialog.setJobValues(job,page),ApiClient.ajax({url:ApiClient.getUrl("Sync/Jobs/"+id),type:"POST",data:JSON.stringify(job),contentType:"application/json"}).then(function(){Dashboard.hideLoadingMsg(),require(["toast"],function(toast){toast(Globalize.translate("SettingsSaved"))})})})})}var _jobOptions;return function(view,params){function onWebSocketMessage(e,msg){"SyncJob"==msg.MessageType&&loadJobInfo(view,msg.Data.Job,msg.Data.JobItems)}function startListening(page){var startParams="0,1500";startParams+=","+getParameterByName("id"),ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("SyncJobStart",startParams)}function stopListening(){ApiClient.isWebSocketOpen()&&ApiClient.sendWebSocketMessage("SyncJobStop","")}view.querySelector(".syncJobForm").addEventListener("submit",function(e){return saveJob(view),e.preventDefault(),!1}),view.querySelector(".jobItems").addEventListener("click",function(e){var btnJobItemMenu=dom.parentWithClass(e.target,"btnJobItemMenu");btnJobItemMenu&&showJobItemMenu(btnJobItemMenu)}),view.addEventListener("viewshow",function(){var page=this;loadJob(page),startListening(page),Events.on(ApiClient,"websocketmessage",onWebSocketMessage)}),view.addEventListener("viewbeforehide",function(){stopListening(),Events.off(ApiClient,"websocketmessage",onWebSocketMessage)})}});